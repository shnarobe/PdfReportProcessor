<!DOCTYPE html>
<html>
	<head>
		<script  src="./pdf.js"></script>
		<script src="./jspdf.debug.js"></script>
		<!--<script src="./emailtest.js"></script>-->
		<script src= "./smtp.js"></script> 
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

	</head>

<body>
<h1>Mass mail reports</h1>

<canvas id="the-canvas"></canvas>
<div id="pdfHolder"></div>

<!-- The `multiple` attribute lets users select multiple files. -->
<input type="file" id="file-selector" >
<script>
	let reportPdf = new jsPDF();
	let xCor=20;
	let yCor=0;
	let successCounter=0;
	let failureCounter=0;
	let failureArray=[];
	 counter = 0;
	//file inpt box
  const fileSelector = document.getElementById('file-selector');
  fileSelector.addEventListener('change', (event) => {
    const fileList = event.target.files;
    console.log(fileList[0].name);
	//call function providing file location
	startingPoint(fileList[0].name);
		
  });
</script>

<script>
function startingPoint(fileName){
//create jspdf object for storing pdf
let docimg = new jsPDF();
numReports=prompt("Please enter the number of reports you're sending out.");
masterEmail=prompt("Please enter your full email address, e.g jdoe@sgu.edu");
masterPassword=prompt("Please enter your password");

EmailText=`Dear student, <br><br>

Your exam results have been released. To view the results:<br>
1. Open the PDF attachment in your web browser<br>
2. or download the PDF attachment on your device<br>
3. and open it using your preferred PDF software. <br><br>

If you encounter any issues, please contact Jason Lucas (jlucas001@sgu.edu), Krishna Robertson (krobert4@sgu.edu) and cc Kevin Parke (kparke2@sgu.edu).<br><br>

Department of Clinical Skills.`;

e=1;
		//loop through entire list of pages
		var inter=setInterval(function(){
		//for(let e=1; e<=numReports;e++){
			//create new canvas for each request, each pdf page is rendered to its own canvas
			var canv = document.createElement("CANVAS");
			var canvName="the-canvas" + e;
			console.log(canvName);
			canv.setAttribute("id", canvName); 
			document.body.appendChild(canv);
			generatePdf(e,canv,fileName);
			
			if(e==numReports){
				clearInterval(inter);
			}
			e++;

		//}
		},10000);
}

function generatePdf(pageN,canvasnum,fName){

//Every call to the API returns a Promise, which allows asynchronous operations to be handled cleanly.
// If absolute URL from the remote server is provided, configure the CORS
// header on that server.
var url ="./" + fName;

pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.js';
// Loaded via <script> tag, create shortcut to access PDF.js exports.
// Asynchronous download of PDF
var pageNumber;
let loadingTask;
var scale = 1.33;


	loadingTask = pdfjsLib.getDocument(url);
	loadingTask.promise.then(function(pdf) {
		console.log('PDF loaded');
  
		// Fetch the first page
  
	
		pageNumber = pageN;
		pdf.getPage(pageNumber).then(function(page) {
		console.log('Page loaded');
		//console.log(pdf.numPages);
    
		//var scale = 1;
		//the view gives access to the dimension properties of the pdf
		 var viewport = page.getViewport({scale: scale});
		 
		// Prepare canvas using PDF page dimensions
		var canvas = canvasnum; //document.getElementById('the-canvas' + i);
		var context = canvas.getContext('2d');
		canvas.height = viewport.height;
		canvas.width = viewport.width;
		imgWidth= viewport.width;
		imgHeight= viewport.height;
		let str=[];
		let email="";
		let emailArr=[];
		//before rendering page extract text, notice that a call to the api method getTextContent returns a promise which we access by then(the true part of the promise)
		var textContent = page.getTextContent();
		textContent.then(function (text) {
		console.log('Page content parsed' );
		for(let j = 0; j < text.items.length; j++) {
			str.push(text.items[j].str);
			//if the username is found, then find the username and create the email address
			console.log(text.items[j]);
			
			if(text.items[j].str==("CORRECT")){
				//console.log(parseInt(text.items[j].transform[4]));
				//var ctx = canvas.getContext("2d");
				//ctx.fillStyle = "#000000";
				//pdf rect coordinates: upper-left x, upper-left y, lower-right x and lower-right y.
				//x-coor, y-coor, width, h.
				//get the x coordinate of the correct column
				 xCorCorrect=parseInt(text.items[j].transform[4])*scale;
				 //get the y coordinate for the correct column
				 yCorCorrect=text.items[j].transform[5] * scale;
				 //get the width of the correct column
				 xWidthCorrect=parseInt(text.items[j].width)*scale;
				 yCorPerLogic=20;
				// coor1=parseInt(text.items[j].transform[5])*1.33;
				//ctx.fillRect(coor,370,70,(imgHeight/2));
			
				}
				
				
				if(text.items[j].str.startsWith("Performance Logic:")){
				
				//pdf rect coordinates: upper-left x, upper-left y, lower-right x and lower-right y.
				//x-coor, y-coor, width, h.
				//get the y coordinate of the performance logic column
				 yCorPerLogic=parseInt(text.items[j].transform[4])* scale;
			
				}
				
			
			
			if(text.items[j].str.startsWith("Username:")){
				//console.log(text.items[j].str);
				email=text.items[j].str;
				emailArr=email.split(":");
				//console.log(emailArr);
				emailArr[1]=emailArr[1].trim();
				//find y coordinates for of username, subtract y coordinates from correct and username column
				yCorUsername=text.items[j].transform[5]*scale;
				if(emailArr[1]==""){
					//if the username is null then get the text on the next line-height
					tempStr=text.items[j+1].str;
					tempStr=tempStr.trim();
					emailArr[1]=tempStr.concat("@sgu.edu");
					console.log(emailArr[1]);
					
				}
				else{//if username is present then build email as normal. Builds email address from captured email on line 154
				emailArr[1]=emailArr[1].concat("@sgu.edu");
				console.log(emailArr[1]);
				}
				
			
			}
			
		  
        }
	
				
    });
	imgWidth=imgWidth - 30;
	imgHeight= imgHeight - 20;
	//now that you have the email address
    // Render PDF page into canvas context so that you can extract image to add to pdf
    var renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    var renderTask = page.render(renderContext);
    renderTask.promise.then(function () {
		console.log('Page rendered');
		//drawing over the corrrect column
		var ctx = canvas.getContext("2d");
		ctx.fillStyle = "#FFFFFF";
		//pdf rect coordinates: upper-left x, upper-left y, lower-right x and lower-right y.
		//Subtract the y coordinates of the username and correct columns to get the starting y coordinate for the correct column
		yCoor=Math.abs(yCorUsername-yCorCorrect);
		//Draw the rectangle: x coor, y coor, width of rectangle is width of correct column, height is y coordinate of correct column - y coordinate of performance logic column
		ctx.fillRect(xCorCorrect,(yCoor+20),xWidthCorrect+2,Math.abs(yCorCorrect-yCorPerLogic)-10);
		console.log("xStart: "+xCorCorrect + "xWidth: "+ xWidthCorrect + "Height: "+Math.abs(yCorCorrect-yCorPerLogic)+"start y: "+yCoor);
		console.log(imgWidth  +" :" + imgHeight);
		var img = new Image(); 
		img.src = canvas.toDataURL("image/jpeg"); 
		img.setAttribute("width",imgWidth);
		img.setAttribute("height",imgHeight);
		document.body.appendChild(img);
	 
		imgWidth=imgWidth - 30;
		imgHeight= imgHeight - 30;
		//add image from cancas to pdf
		docimg= new jsPDF('p','pt','a4');
		docimg.addImage(img,"JPEG",0,10);
	
		//create pdf and output to string,base64 encoding
		var string=docimg.output('datauri');
		
		Email.send({
		Host: "smtp.office365.com",
		Username : masterEmail,
		Password : masterPassword,
		To : emailArr[1],
		From : masterEmail,
		Subject : "ExamSoft Strengths and Opportunities Report Released.",
		Body : EmailText,
		Attachments : [
		{
			name : "Report.pdf",
			data : string

		}]
		}).then(function (message) { 
          console.log("mail sent successfully");
		  
		  //clear the canvas
		/*if (context) {
			context.clearRect(0, 0, canvas.width, canvas.height);
			context.beginPath();
		}*/
		//remove the image
		img.remove();
		//add entry to report
		let tempTxt=emailArr[1];
		//check that returned code is 'OK', else an error occurred.
		if(message=="OK"){
			successCounter=successCounter + 1;
		}
		else{
			//if email failed, increment counter and write username
			failureCounter = failureCounter + 1;
			failureArray.push(emailArr[1]+" "+ message);
			console.log(message);
		}
			//increment after every email is sent
		 counter=counter+1;
		 //once last email is sent then generate report
		if(counter==numReports){
			console.log(counter +" " + numReports);
			//default coordinates are in mm units(279 mm long)
			reportPdf.text(successCounter + " student reports emailed successfully.",xCor,yCor+10);
			yCor=yCor + 10;
			//loop through failure array if any
			if(failureCounter > 0){
				for(let ru=0; ru <= failureArray.length; ru++){
					//add failed entry to report
					reportPdf.text(failureArray[ru] + ": Email failed: ",xCor,yCor+10);
					yCor=yCor+10;
					//if yCor position is >250mm then go to next page
					if(yCor>240){
					//create new page with default values to pdf and reset y coordinate
						reportPdf.addPage();
						yCor=10;
					
					}
			
				}
			}
		
		
			outputPdf=reportPdf.output("datauri");
			
			var string1 = outputPdf;// doc.output('datauristring');
			var embed = "<embed width='100%' height='100%' src='" + string1 + "'/>"
			var x = window.open();
			x.document.open();
			x.document.write(embed);
			x.document.close();
			//document.body.appendChild(embed);
	 
		
		}
        }); 
		
	//
    });
	//attempt to convert canvas
	
	
	//sendEmail(page);
  
  });
 
});
//, function (reason) {
  // PDF loading error
  //console.error(reason);
//});
}

</script>
</body>

</html>
